var cur={type:null,num:0,arrX:null,arrY:null,color:null,state:0,spawn:function(){cur.type=nextCur.type;cur.num=nextCur.num;cur.arrX=nextCur.arrX;cur.arrY=nextCur.arrY;cur.color=nextCur.color cur.state=nextCur.state;nextCur.spawn()}};var nextCur={type:null,num:0,arrX:null,arrY:null,color:null,colors:["red","yellow","blue","green","white","aqua","violet","tomato"],state:0,spawn:function(){var types=['S','Z','L','J','I','O','T'];nextCur.type=types[Math.round(Math.random()*100)%7];function init(num){nextCur.num=num;nextCur.arrX=new Array();nextCur.arrY=new Array();nextCur.color=nextCur.colors[Math.round(Math.random()*100)%nextCur.colors.length]}init(4);switch(nextCur.type){case'S':nextCur.arrX[0]=5;nextCur.arrY[0]=-2;nextCur.arrX[1]=4;nextCur.arrY[1]=-2;nextCur.arrX[2]=4;nextCur.arrY[2]=-1;nextCur.arrX[3]=3;nextCur.arrY[3]=-1;break;case'Z':nextCur.arrX[0]=4;nextCur.arrY[0]=-2;nextCur.arrX[1]=5;nextCur.arrY[1]=-2;nextCur.arrX[2]=5;nextCur.arrY[2]=-1;nextCur.arrX[3]=6;nextCur.arrY[3]=-1;break;case'L':nextCur.arrX[0]=5;nextCur.arrY[0]=-2;nextCur.arrX[1]=5;nextCur.arrY[1]=-1;nextCur.arrX[2]=4;nextCur.arrY[2]=-1;nextCur.arrX[3]=3;nextCur.arrY[3]=-1;break;case'J':nextCur.arrX[0]=4;nextCur.arrY[0]=-2;nextCur.arrX[1]=4;nextCur.arrY[1]=-1;nextCur.arrX[2]=5;nextCur.arrY[2]=-1;nextCur.arrX[3]=6;nextCur.arrY[3]=-1;break;case'I':nextCur.arrX[0]=3;nextCur.arrY[0]=-1;nextCur.arrX[1]=4;nextCur.arrY[1]=-1;nextCur.arrX[2]=5;nextCur.arrY[2]=-1;nextCur.arrX[3]=6;nextCur.arrY[3]=-1;break;case'O':nextCur.arrX[0]=4;nextCur.arrY[0]=-2;nextCur.arrX[1]=5;nextCur.arrY[1]=-2;nextCur.arrX[2]=4;nextCur.arrY[2]=-1;nextCur.arrX[3]=5;nextCur.arrY[3]=-1;break;case'T':nextCur.arrX[0]=4;nextCur.arrY[0]=-2;nextCur.arrX[1]=3;nextCur.arrY[1]=-1;nextCur.arrX[2]=4;nextCur.arrY[2]=-1;nextCur.arrX[3]=5;nextCur.arrY[3]=-1;break}}};var gameEnv={left:function(){for(let i=0;i<cur.num;i++){let exists=game.scene[cur.arrY[i]]!=null&&game.scene[cur.arrY[i]][cur.arrX[i]-1]!=null;if(cur.arrX[i]<=0||exists)return}for(let i=0;i<cur.num;i++)cur.arrX[i]--},right:function(){for(let i=0;i<cur.num;i++){let exists=game.scene[cur.arrY[i]]!=null&&game.scene[cur.arrY[i]][cur.arrX[i]+1]!=null;if(cur.arrX[i]>=9||exists)return}for(let i=0;i<cur.num;i++)cur.arrX[i]++},up:function(){if(cur.type=='O')return;cur.state=(cur.state+1)%4;var arrX=new Array();var arrY=new Array();switch(cur.type){case'S':if(cur.state==0){arrX[0]=cur.arrX[0]+2;arrY[0]=cur.arrY[0];arrX[1]=cur.arrX[1]+1;arrY[1]=cur.arrY[1]-1;arrX[3]=cur.arrX[3]-1;arrY[3]=cur.arrY[3]-1}else if(cur.state==1){arrX[0]=cur.arrX[0];arrY[0]=cur.arrY[0]+2;arrX[1]=cur.arrX[1]+1;arrY[1]=cur.arrY[1]+1;arrX[3]=cur.arrX[3]+1;arrY[3]=cur.arrY[3]-1}else if(cur.state==2){arrX[0]=cur.arrX[0]-2;arrY[0]=cur.arrY[0];arrX[1]=cur.arrX[1]-1;arrY[1]=cur.arrY[1]+1;arrX[3]=cur.arrX[3]+1;arrY[3]=cur.arrY[3]+1}else if(cur.state==3){arrX[0]=cur.arrX[0];arrY[0]=cur.arrY[0]-2;arrX[1]=cur.arrX[1]-1;arrY[1]=cur.arrY[1]-1;arrX[3]=cur.arrX[3]-1;arrY[3]=cur.arrY[3]+1}break;case'Z':if(cur.state==0){arrX[0]=cur.arrX[0];arrY[0]=cur.arrY[0]-2;arrX[1]=cur.arrX[1]+1;arrY[1]=cur.arrY[1]-1;arrX[3]=cur.arrX[3]+1;arrY[3]=cur.arrY[3]+1}else if(cur.state==1){arrX[0]=cur.arrX[0]+2;arrY[0]=cur.arrY[0];arrX[1]=cur.arrX[1]+1;arrY[1]=cur.arrY[1]+1;arrX[3]=cur.arrX[3]-1;arrY[3]=cur.arrY[3]+1}else if(cur.state==2){arrX[0]=cur.arrX[0];arrY[0]=cur.arrY[0]+2;arrX[1]=cur.arrX[1]-1;arrY[1]=cur.arrY[1]+1;arrX[3]=cur.arrX[3]-1;arrY[3]=cur.arrY[3]-1}else if(cur.state==3){arrX[0]=cur.arrX[0]-2;arrY[0]=cur.arrY[0];arrX[1]=cur.arrX[1]-1;arrY[1]=cur.arrY[1]-1;arrX[3]=cur.arrX[3]+1;arrY[3]=cur.arrY[3]-1}break;case'L':if(cur.state==0){arrX[0]=cur.arrX[0]+2;arrY[0]=cur.arrY[0];arrX[1]=cur.arrX[1]+1;arrY[1]=cur.arrY[1]+1;arrX[3]=cur.arrX[3]-1;arrY[3]=cur.arrY[3]-1}else if(cur.state==1){arrX[0]=cur.arrX[0];arrY[0]=cur.arrY[0]+2;arrX[1]=cur.arrX[1]-1;arrY[1]=cur.arrY[1]+1;arrX[3]=cur.arrX[3]+1;arrY[3]=cur.arrY[3]-1}else if(cur.state==2){arrX[0]=cur.arrX[0]-2;arrY[0]=cur.arrY[0];arrX[1]=cur.arrX[1]-1;arrY[1]=cur.arrY[1]-1;arrX[3]=cur.arrX[3]+1;arrY[3]=cur.arrY[3]+1}else if(cur.state==3){arrX[0]=cur.arrX[0];arrY[0]=cur.arrY[0]-2;arrX[1]=cur.arrX[1]+1;arrY[1]=cur.arrY[1]-1;arrX[3]=cur.arrX[3]-1;arrY[3]=cur.arrY[3]+1}break;case'J':if(cur.state==0){arrX[0]=cur.arrX[0];arrY[0]=cur.arrY[0]-2;arrX[1]=cur.arrX[1]-1;arrY[1]=cur.arrY[1]-1;arrX[3]=cur.arrX[3]+1;arrY[3]=cur.arrY[3]+1}else if(cur.state==1){arrX[0]=cur.arrX[0]+2;arrY[0]=cur.arrY[0];arrX[1]=cur.arrX[1]+1;arrY[1]=cur.arrY[1]-1;arrX[3]=cur.arrX[3]-1;arrY[3]=cur.arrY[3]+1}else if(cur.state==2){arrX[0]=cur.arrX[0];arrY[0]=cur.arrY[0]+2;arrX[1]=cur.arrX[1]+1;arrY[1]=cur.arrY[1]+1;arrX[3]=cur.arrX[3]-1;arrY[3]=cur.arrY[3]-1}else if(cur.state==3){arrX[0]=cur.arrX[0]-2;arrY[0]=cur.arrY[0];arrX[1]=cur.arrX[1]-1;arrY[1]=cur.arrY[1]+1;arrX[3]=cur.arrX[3]+1;arrY[3]=cur.arrY[3]-1}break;case'I':if(cur.state==0){arrX[0]=cur.arrX[0]-2;arrY[0]=cur.arrY[0]-2;arrX[1]=cur.arrX[1]-1;arrY[1]=cur.arrY[1]-1;arrX[3]=cur.arrX[3]+1;arrY[3]=cur.arrY[3]+1}else if(cur.state==1){arrX[0]=cur.arrX[0]+2;arrY[0]=cur.arrY[0]-2;arrX[1]=cur.arrX[1]+1;arrY[1]=cur.arrY[1]-1;arrX[3]=cur.arrX[3]-1;arrY[3]=cur.arrY[3]+1}else if(cur.state==2){arrX[0]=cur.arrX[0]+2;arrY[0]=cur.arrY[0]+2;arrX[1]=cur.arrX[1]+1;arrY[1]=cur.arrY[1]+1;arrX[3]=cur.arrX[3]-1;arrY[3]=cur.arrY[3]-1}else if(cur.state==3){arrX[0]=cur.arrX[0]-2;arrY[0]=cur.arrY[0]+2;arrX[1]=cur.arrX[1]-1;arrY[1]=cur.arrY[1]+1;arrX[3]=cur.arrX[3]+1;arrY[3]=cur.arrY[3]-1}break;case'T':if(cur.state==0){arrX[0]=cur.arrX[0]+1;arrY[0]=cur.arrY[0]-1;arrX[1]=cur.arrX[1]-1;arrY[1]=cur.arrY[1]-1;arrX[3]=cur.arrX[3]+1;arrY[3]=cur.arrY[3]+1}else if(cur.state==1){arrX[0]=cur.arrX[0]+1;arrY[0]=cur.arrY[0]+1;arrX[1]=cur.arrX[1]+1;arrY[1]=cur.arrY[1]-1;arrX[3]=cur.arrX[3]-1;arrY[3]=cur.arrY[3]+1}else if(cur.state==2){arrX[0]=cur.arrX[0]-1;arrY[0]=cur.arrY[0]+1;arrX[1]=cur.arrX[1]+1;arrY[1]=cur.arrY[1]+1;arrX[3]=cur.arrX[3]-1;arrY[3]=cur.arrY[3]-1}else if(cur.state==3){arrX[0]=cur.arrX[0]-1;arrY[0]=cur.arrY[0]-1;arrX[1]=cur.arrX[1]-1;arrY[1]=cur.arrY[1]+1;arrX[3]=cur.arrX[3]+1;arrY[3]=cur.arrY[3]-1}break}--cur.state;if(arrX[0]<0||arrX[0]>9||arrX[1]<0||arrX[1]>9||arrX[3]<0||arrX[3]>9)return;if(arrY[0]>19||arrY[1]>19||arrY[3]>19)return;if(game.scene[arrY[0]]==null||game.scene[arrY[0]][arrX[0]]!=null)return;if(game.scene[arrY[1]]==null||game.scene[arrY[1]][arrX[1]]!=null)return;if(game.scene[arrY[3]]==null||game.scene[arrY[3]][arrX[3]]!=null)return;cur.arrX[0]=arrX[0];cur.arrY[0]=arrY[0];cur.arrX[1]=arrX[1];cur.arrY[1]=arrY[1];cur.arrX[3]=arrX[3];cur.arrY[3]=arrY[3];++cur.state},down:function(){for(let i=0;i<cur.num;i++){let exists=game.scene[cur.arrY[i]+1]!=null&&game.scene[cur.arrY[i]+1][cur.arrX[i]]!=null;if(cur.arrY[i]>=19||exists){gameEnv.finish();return true}}for(let i=0;i<cur.num;i++){cur.arrY[i]++}},downMax:function(){while(gameEnv.down()!=true)},finish:function(){for(let i=0;i<cur.num;i++){if(cur.arrY[i]<0){game.over();return}}for(let i=0;i<cur.num;i++){game.scene[cur.arrY[i]][cur.arrX[i]]=cur.color}cur.spawn();let num=0;Y:for(let i=19;i>num;i--){for(let j=0;j<10;j++)if(game.scene[i][j]==null)continue Y;if(i>++num){for(let k=i-1;k>num;k--)game.scene[k+1]=game.scene[k]}else{for(let j=0;j<10;j++){game.scene[i][j]=null}}++i}switch(num){case 1:game.scope+=100;break;case 2:game.scope+=200;break;case 3:game.scope+=400;break;case 4:game.scope+=800;break}}};var game={cvs:null,ctx:null,time:0,speed:10,dSpeed:10,size:20,minX:140,minY:100,maxX:320,maxY:480,scope:0,isPause:true,scene:null,init:function(cvs){if(game.cvs==null){game.cvs=cvs;game.ctx=cvs.getContext("2d")}game.bg();game.ctx.fillStyle="rgba(255, 255, 255, 0.2)"game.ctx.fillRect(0,0,480,600);game.ctx.fillStyle="aqua";game.ctx.font="24px 宋体";game.ctx.fillText("开始游戏",190,300);game.cvs.onclick=function(env){if(env.offsetX>180&&env.offsetX<290&&env.offsetY>270&&env.offsetY<310){game.run();nextCur.spawn()cur.spawn();game.cvs.onclick=function(env){var up=env.offsetX>40&&env.offsetX<80&&env.offsetY>165&&env.offsetY<210;var down=env.offsetX>40&&env.offsetX<80&&env.offsetY>265&&env.offsetY<310;var left=env.offsetX<45&&env.offsetY>215&&env.offsetY<260;var right=env.offsetX>70&&env.offsetX<110&&env.offsetY>215&&env.offsetY<260;var downMax=env.offsetX>40&&env.offsetX<80&&env.offsetY>315&&env.offsetY<360;var pause=env.offsetX>20&&env.offsetX<100&&env.offsetY>55&&env.offsetY<130;if(up)gameEnv.up();else if(down)gameEnv.down();else if(left)gameEnv.left();else if(right)gameEnv.right();else if(downMax)gameEnv.downMax();else if(pause)game.pause()}}};game.scope=0;game.speed=game.dSpeed;game.time=0;game.scene=new Array();for(var i=0;i<20;i++)game.scene[i]=new Array()},gameKeyEnv:function(env){if(env.keyCode==97||env.keyCode==65){gameEnv.left()}else if(env.keyCode==100||env.keyCode==68){gameEnv.right()}else if(env.keyCode==119||env.keyCode==87){gameEnv.up()}else if(env.keyCode==115||env.keyCode==83){gameEnv.down()}else if(env.keyCode==118||env.keyCode==86){gameEnv.downMax()}},num:0,start:function(){game.bg();game.ctx.fillStyle="white";game.ctx.fillText("分数:"+game.scope,120,60);game.ctx.fillText("坚持时间:"+Math.round(game.time),250,60);game.ctx.fillStyle=cur.color;for(let i=0;i<cur.num;i++){game.ctx.fillRect(game.minX+game.size*cur.arrX[i],game.minY+game.size*cur.arrY[i],game.size,game.size)};game.ctx.fillStyle=nextCur.color;for(let i=0;i<nextCur.num;i++){game.ctx.fillRect(game.minX+180+game.size*nextCur.arrX[i],game.minY+game.size*nextCur.arrY[i],game.size,game.size)};for(let i=0;i<game.scene.length;i++){for(let j=0;j<game.scene[i].length;j++){if(game.scene[i][j]!=null){game.ctx.fillStyle=game.scene[i][j];game.ctx.fillRect(game.minX+j*game.size,game.minY+i*game.size,game.size,game.size)}}}if(game.num++==game.speed){game.num=0;gameEnv.down();if(game.speed!=2){game.speed=10-Math.round(game.time/30)}}game.time+=0.05;if(!game.isPause)setTimeout("game.start()",50)},pause:function(){game.isPause=true;window.onkeypress=null;pause()},run:function(){if(game.isPause==false)return;game.isPause=false;game.start();window.onkeypress=game.gameKeyEnv},over:function(){game.isPause=true;window.onkeypress=null;over(game.scope)},bg:function(){game.ctx.fillStyle="black";game.ctx.fillRect(0,0,480,600);game.ctx.fillStyle="#9ba7ba"game.ctx.fillRect(120,80,20,440);game.ctx.fillRect(340,80,20,440);game.ctx.fillRect(140,80,200,20);game.ctx.fillRect(140,500,200,20);game.ctx.fillStyle="green";game.ctx.fillRect(41,168,40,40);game.ctx.fillRect(41,268,40,40);game.ctx.fillRect(41,320,40,40);game.ctx.fillRect(5,218,40,40);game.ctx.fillRect(72,218,40,40);game.ctx.fillRect(20,90,80,40);game.ctx.fillStyle="red";game.ctx.font="22px 宋体 bold";game.ctx.fillText("↑W",44,200);game.ctx.fillText("↓S",46,300);game.ctx.fillText("↓|V",44,350);game.ctx.fillText("←A",5,250);game.ctx.fillText("→D",73,250);game.ctx.fillText("暂停",38,120)}};